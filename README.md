# محرر السيناريو (Screenplay Editor)

## 1. نظرة عامة
محرر سيناريو متقدم مخصص باللغة العربية، مبني على Tiptap v3 و React، يوفر واجهة كتابة غنية تُمكن الكُتّاب من تنسيق نصوص السيناريو بسهولة ومعايير الصناعة.

## 2. الميزات الأساسية
- **تنسيق ذكي**: اكتشاف تلقائي للأنماط (مشهد، شخصية، حوار، بسمة) أثناء الكتابة أو اللصق.
- **استيراد ملفات**: دعم Word (docx), PDF, Fountain, و FDX.
- **نظام الكتابة المتقدم**: أوضاع (Plain, Auto-deferred, Auto-live) للتحكم في معالجة النص.
- **إحصائيات فورية**: تتبع عدد الكلمات، الصفحات، والمشاهد بدقة.
- **واجهة مستخدم معاصرة**: واجهة داكنة مريحة للعين مبنية بـ TailwindCSS و Framer Motion.

## 3. التقنيات الأساسية (Tech Stack)
- **الإطار**: React 19, Vite 6
- **المحرر الأساسي**: Tiptap v3
- **التنسيق**: TailwindCSS, Shadcn-UI, Radix UI
- **المنطق**: TypeScript 5.7
- **الاستيراد**: Mammoth (docx), PDF.js (pdf)

## 4. البدء السريع (Quick Start)
```bash
# تثبيت التبعيات
pnpm install

# تشغيل خادم التطوير
pnpm dev

# بناء نسخة الإنتاج
pnpm build
```

## 5. بنية المشروع (Project Structure)
```
/src
 ├── /components  
 │    ├── /editor  # مكونات المحرر (Header, Area, Footer)
 │    └── /ui      # مكونات واجهة المستخدم الأساسية (Shadcn)
 ├── /extensions  # منطق Tiptap لاكتشاف الأنماط العربية والمشاهد
 ├── /types       # تعريفات TypeScript ونماذج البيانات
 ├── /utils       # استيراد الملفات، المعالجة المسبقة، وأدوات المساعدة
 ├── /styles      # ملفات CSS العامة والخاصة بالمحرر
 └── /hooks       # Hooks مخصصة لإدارة الحالة والحافظة
```

## 6. الآلية الأساسية (Core Mechanism)
يعتمد المشروع على محرك Tiptap Headless مع قائمة من الإضافات المخصصة (`Extensions`) التي تحلل النص العربي وتمنحه شكلاً هيكلياً (Schema). [استعرض التفاصيل في CORE_MECHANISM.md](docs/CORE_MECHANISM.md).

## 7. الهيكلية المعمارية (Architecture)
المشروع يتبع نمط الطبقات الموزعة حيث يتم فصل واجهة العرض عن منطق معالجة النصوص.
- **طبقة العرض**: مكونات React.
- **طبقة المعالجة**: إضافات Tiptap وخطوط أنابيب (Pipelines) لتحويل النصوص الخام إلى كتل برمجية.

## 8. تدفق البيانات (Data Flow)
1. **الإدخال**: (كتابة، لصق، أو استيراد ملف).
2. **المعالجة المسبقة**: تنظيف النص وتحويله إلى كتل (Blocks).
3. **التصنيف**: استخدام `Classification Core` لتحديد نوع كل كتلة.
4. **التحويل**: حقن الكتل في State الخاص بـ Tiptap.
5. **العرض**: تحديث شاشة المحرر والإحصائيات.

## 9. إدارة الحالة (State Management)
يتم إدارتها محلياً عبر React Hooks و Tiptap State، مع استخدام `LocalStorage` لحفظ المسودات والإعدادات.

## 10. القرارات المعمارية (ADRs)
1. **استخدام Tiptap v3**: لتوفير مرونة كاملة في تخصيص سلوك المفاتيح (Enter, Tab) بما يتناسب مع كتابة السيناريو.
2. **نظام التصنيف المحلي**: البدء بقواعد Regex وأنماط متسلسلة للسرعة، مع إمكانية المراجعة بواسطة عميل AI (Agent Review).
3. **تصميم الصفحة الحقيقي**: محاكاة شكل ورقة A4 داخل المتصفح لضمان توافق التنسيق مع الطباعة.

## 11. حل المشاكل (Troubleshooting)
- **فشل الاستيراد**: تأكد من أن الملف غير محمي بكلمة سر واستخدم خيار "Plain Text" كحل بديل.
- **خطوط اللغة العربية**: المحرر يعتمد على خطوط مخصصة موجودة في مجلد `/fonts`.

## 12. الواجهات البرمجية (APIs)
- الملفات لا تدعو واجهات خارجية حالياً عدا AI Review الاختياري عبر `Mistral AI`.

## 13. الإضافات (Extensions)
- `ArabicPatterns`: معالجة خاصة للبنية اللغوية العربية.
- `SceneHeader`: اكتشاف وتنسيق رؤوس المشاهد تلقائياً.
- `Character/Dialogue`: الربط التلقائي بين المتحدث وكلامه.

## 14. الأوامر البرمجية (Scripts)
- `pnpm dev`: تشغيل المحرر محلياً.
- `pnpm build`: التجميع للإنتاج.
- `pnpm build-antiword`: أدوات بناء داخلية لتحويل الملفات القديمة.

## 15. متغيرات البيئة (Environment Variables)
- `VITE_MISTRAL_API_KEY`: مفتاح AI لمراجعة النصوص (اختياري).

## 16. المساهمة (Contributing)
المشروع خاص، يرجى مراجعة المسؤول قبل تقديم أي Pull Request.

## 17. الاختبارات (Testing)
توجد اختبارات دخان (Smoke tests) في مجلد `scripts/` لفحص استخراج النصوص.

## 18. التراخيص (License)
(Proprietary / Private) جميع الحقوق محفوظة.

## 19. المصطلحات الأساسية (Glossary)
- **Block**: وحدة نصية في السيناريو (حوار، مشهد، وصف).
- **Classification**: عملية تحديد نوع السطر نصياً.
- **Tiptap**: المحرك البرمجي الذي بني عليه المحرر.
