# أفان تيتر — Avan Titre

> محرر سيناريو عربي احترافي مبني للويب

---

## 1. نظرة عامة

أفان تيتر هو محرر نصوص سيناريو متخصص في الكتابة الدرامية العربية. يعمل بالكامل داخل المتصفح، ويوفر تصنيفاً تلقائياً ذكياً لعناصر السيناريو، وتخطيطاً صفحياً يحاكي معايير الصناعة (صفحة واحدة ≈ دقيقة شاشة واحدة)، وتجربة كتابة طبيعية لا تقاطع تدفق الكاتب.

---

## 2. المشكلة التي يحلها

كتّاب السيناريو العرب يواجهون ثلاث مشكلات أساسية:

1. **غياب أدوات متخصصة**: برامج السيناريو العالمية (Final Draft, Celtx) لا تدعم العربية بشكل كامل — خاصةً التنسيق RTL والتصنيف التلقائي للنص العربي
2. **التنسيق اليدوي المُرهق**: تحويل النص العادي إلى تنسيق سيناريو احترافي يستهلك وقتاً كبيراً
3. **استيراد النصوص القديمة**: آلاف السيناريوهات موجودة بصيغ PDF وWord بدون هيكلة — تحتاج تصنيفاً يدوياً مضنياً

---

## 3. الحل

أفان تيتر يحل هذه المشكلات عبر:

- **تصنيف تلقائي متعدد الطبقات**: 4 طبقات تصنيف (regex → سياق → هجين → وكيل AI) تُحوّل النص العادي لعناصر سيناريو مهيكلة بدقة عالية
- **سلسلة Enter الذكية**: مفتاح Enter ينقل الكاتب تلقائياً للعنصر التالي المنطقي (مشهد → وصف → شخصية → حوار)
- **تخطيط A4 حقيقي**: ترقيم وتقسيم صفحات تلقائي يحاكي الطباعة الاحترافية
- **استيراد ذكي**: فتح ملفات PDF, TXT, Fountain, FDX مع تصنيف تلقائي

---

## 4. المكدس التقني

| التقنية      | الإصدار     | الغرض                      |
| ------------ | ----------- | -------------------------- |
| React        | 19          | الغلاف البصري (shell UI)   |
| TypeScript   | strict mode | اللغة الأساسية             |
| Vite         | —           | أداة البناء                |
| Tiptap       | —           | محرك التحرير (ProseMirror) |
| Radix UI     | —           | مكونات UI الأساسية         |
| Tailwind CSS | —           | التنسيق                    |
| OKLCH        | —           | رموز التصميم اللونية       |

---

## 5. بنية المشروع

```
src/
├── App.tsx                    # مكون React الجذر
├── editor.ts                  # مصنع محرر Tiptap
├── toolbar.ts                 # شريط أدوات قديم (vanilla JS)
├── main.tsx                   # نقطة الدخول
├── components/
│   ├── editor/                # EditorArea + الغلاف البصري (9 ملفات)
│   └── ui/                    # مكونات Radix UI (53 ملف)
├── constants/                 # ألوان، خطوط، تنسيقات، أبعاد (7 ملفات)
├── extensions/                # عُقد Tiptap + خط أنابيب التصنيف (21 ملف)
├── hooks/                     # خطافات React مخصصة (5 ملفات)
├── lib/                       # أداة cn() (1 ملف)
├── providers/                 # ThemeProvider (2 ملف)
├── styles/                    # CSS مقسم حسب الاهتمام (6 ملفات)
├── types/                     # أنماط TypeScript (8 ملفات)
└── utils/                     # المسجل + خط أنابيب الاستيراد (9 ملفات)
```

**الإجمالي**: 132 ملف (124 TypeScript/TSX + 6 CSS + 2 أخرى)

---

## 6. النمط المعماري

المشروع يتبع نمطاً **هجيناً**:

- **React** للغلاف الخارجي: `App.tsx` يملك حالة UI وقوائم واختصارات
- **فئات حتمية** (imperative classes) لمحرك التحرير والمكونات البصرية: `EditorArea`, `EditorHeader`, `EditorToolbar`, `EditorFooter`, `EditorSidebar`
- **مصنع DOM** لمكونات Radix UI: `_factory.ts` يُنشئ عناصر DOM مباشرة بدون JSX

**السبب**: Tiptap/ProseMirror يعمل بنموذج حتمي. استخدام فئات حتمية يتجنب مشاكل المزامنة بين حالة React وحالة المحرر، ويوفر أداءً أفضل مع التحديثات المتكررة.

---

## 7. عناصر السيناريو

| العنصر         | المعرف                  | الاختصار | اللون     |
| -------------- | ----------------------- | -------- | --------- |
| البسملة        | `basmala`               | —        | ذهبي      |
| رأس المشهد (1) | `scene-header-1`        | Ctrl+1   | أخضر      |
| رأس المشهد (2) | `scene-header-2`        | —        | أخضر فاتح |
| رأس المشهد (3) | `scene-header-3`        | —        | أخضر أفتح |
| فوتو مونتاج    | `scene-header-top-line` | —        | أصفر      |
| الوصف/الحركة   | `action`                | Ctrl+4   | أبيض      |
| اسم الشخصية    | `character`             | Ctrl+2   | أزرق      |
| الحوار         | `dialogue`              | Ctrl+3   | بنفسجي    |
| تعليمات الحوار | `parenthetical`         | —        | وردي      |
| الانتقال       | `transition`            | Ctrl+6   | برتقالي   |

---

## 8. سلسلة مفتاح Enter

عند الضغط على Enter، ينتقل المحرر تلقائياً للنوع التالي:

```
بسملة → فوتو مونتاج → رأس مشهد 1 → رأس مشهد 2 → رأس مشهد 3 → وصف
وصف → وصف (استمرار)
شخصية → حوار
حوار → وصف
تعليمات حوار → حوار
انتقال → فوتو مونتاج
```

### تدوير Tab

```
وصف → شخصية → حوار → تعليمات حوار → انتقال → وصف
```

---

## 9. خط أنابيب التصنيف التلقائي

4 طبقات بأولوية تنازلية:

1. **كاشفات Regex** (`arabic-patterns.ts`): أنماط عربية محددة لرؤوس المشاهد والانتقالات وأسماء الشخصيات — تُعالج الحالات الواضحة فوراً
2. **قواعد السياق** (`classification-sequence-rules.ts`): تستخدم ذاكرة آخر 8 أنواع وتكرارات أسماء الشخصيات
3. **المصنف الهجين** (`hybrid-classifier.ts`): يجمع بين كل الإشارات مع درجات ثقة
4. **وكيل AI** (اختياري): Claude Opus 4.6 عبر `/api/agent/review` — يُفعّل فقط عند شك ≥ 74 مع ≥ 2 إشارات

بعد التصنيف، `PostClassificationReviewer` يفحص 5 أنواع من الشك ويُفعّل المراجعة عن بُعد عند الحاجة.

---

## 10. استيراد الملفات

### الأنواع المدعومة

| الصيغة      | الامتداد    | طريقة الاستخراج                   |
| ----------- | ----------- | --------------------------------- |
| PDF         | `.pdf`      | Backend (OCR اختياري عبر Mistral) |
| Word        | `.doc`      | Backend                           |
| نص عادي     | `.txt`      | Browser (FileReader)              |
| Fountain    | `.fountain` | Browser                           |
| Final Draft | `.fdx`      | Browser (XML)                     |

### خط الأنابيب

```
اختيار الملف → استخراج النص → معالجة مسبقة → تصنيف → نموذج المستند → إدراج في المحرر
```

المعالج المسبق يُطبّق تطبيعاً خاصاً بنوع الملف: إزالة أرقام الصفحات من PDF، توحيد أحرف الأسطر.

---

## 11. تخطيط الصفحة

| المعامل            | القيمة                                         |
| ------------------ | ---------------------------------------------- |
| أبعاد الصفحة       | 794 × 1123 بكسل (A4 @ 96 PPI)                  |
| الهوامش            | علوي/سفلي 77px، أيسر 96px، أيمن 120px          |
| ارتفاع المحتوى     | 969px                                          |
| الفجوة بين الصفحات | 24px                                           |
| الخط               | AzarMehrMonospaced-San — 12pt، تباعد أسطر 15pt |

الترقيم يُدار بواسطة Tiptap Pages Extension مع ResizeObserver وMutationObserver لتحديث فوري.

---

## 12. نموذج المستند

المستند يُمثّل داخلياً كمصفوفة من `ScreenplayBlock`:

```typescript
interface ScreenplayBlock {
  type: ElementType; // 'action' | 'character' | 'dialogue' | ...
  text: string;
  attrs: Record<string, unknown>;
}
```

### التسلسل

يُحفظ بصيغة `ScreenplayPayloadV1` مع:

- ترميز Base64 للمحتوى
- تدقيق FNV1a hash
- إصدار بروتوكول

### الحافظة المخصصة

```
MIME: application/x-filmlane-blocks+json
```

النسخ داخل التطبيق يحفظ معلومات التصنيف. اللصق من خارج التطبيق يمر عبر خط أنابيب التصنيف.

---

## 13. نظام السمات

- **المزود**: فئة `ThemeProvider` (class-based، ليس React Context)
- **الوضع الافتراضي**: داكن (dark)
- **التخزين**: `localStorage` بمفتاح `filmlane.theme`
- **التطبيق**: كتابة مباشرة على `document.documentElement`

---

## 14. الألوان والتصميم

- **العلامة التجارية**: Jungle Green (#029784)، Teal (#40A5B3)، Bronze (#746842)
- **رموز التصميم**: متغيرات CSS مخصصة بنظام OKLCH
- **التصميم**: داكن فقط (dark-only)
- **الاتجاه**: RTL بالكامل

---

## 15. الاختصارات

| الاختصار | الوظيفة                |
| -------- | ---------------------- |
| Ctrl+1   | رأس المشهد (1)         |
| Ctrl+2   | اسم الشخصية            |
| Ctrl+3   | الحوار                 |
| Ctrl+4   | الوصف/الحركة           |
| Ctrl+6   | الانتقال               |
| Ctrl+Z   | تراجع                  |
| Ctrl+Y   | إعادة                  |
| Ctrl+B   | غامق                   |
| Ctrl+I   | مائل                   |
| Ctrl+U   | تسطير                  |
| Tab      | تدوير نوع العنصر       |
| Enter    | الانتقال للعنصر التالي |

---

## 16. الخطافات المخصصة (Hooks)

| الخطاف          | الملف                  | الوظيفة                                |
| --------------- | ---------------------- | -------------------------------------- |
| `useHistory<T>` | `use-history.ts`       | تراجع/إعادة مع اشتراكات                |
| `useAutoSave`   | `use-local-storage.ts` | حفظ تلقائي مع تأخير 3 ثوانٍ            |
| `useToast`      | `use-toast.ts`         | إشعارات (حد أقصى 3، إزالة بعد 5 ثوانٍ) |
| `useIsMobile`   | `use-mobile.ts`        | كشف الموبايل (عتبة 768px)              |

---

## 17. مكونات UI

53 مكون Radix UI مبني بنمط مصنع DOM الحتمي (`_factory.ts`). لا تستخدم JSX (باستثناء `hover-border-gradient.tsx` — مكون Aceternity UI).

المكونات تشمل: Accordion, Alert, Dialog, Dropdown, Sheet, Sidebar, Tabs, Toast, Tooltip، وغيرها.

---

## 18. اصطلاحات الكود

| العنصر            | الاصطلاح                          |
| ----------------- | --------------------------------- |
| أسماء الملفات     | `kebab-case.ts`                   |
| مكونات المحرر     | `PascalCase.ts` (فئات)            |
| الأنماط والواجهات | `PascalCase`                      |
| الثوابت           | `SCREAMING_SNAKE_CASE`            |
| الخطافات          | بادئة `use-` في الملف والتصدير    |
| الاستيرادات       | barrel `index.ts` + `import type` |
| مسار مختصر        | `@/*` → `./src/*`                 |
| نصوص الواجهة      | عربي بالكامل                      |
| مفاتيح العناصر    | camelCase إنجليزي                 |

---

## 19. التوثيق الإضافي

| الملف                                              | الوصف                                              |
| -------------------------------------------------- | -------------------------------------------------- |
| [`docs/CORE_MECHANISM.md`](docs/CORE_MECHANISM.md) | تحليل آلية العمل الأساسية مع مخططات Mermaid        |
| [`docs/FILE_RELATIONS.md`](docs/FILE_RELATIONS.md) | خرائط علاقات الملفات بناءً على الاستيرادات الفعلية |
| [`docs/PROGRESS.md`](docs/PROGRESS.md)             | تتبع تقدم التوثيق                                  |
| [`CLAUDE.md`](CLAUDE.md)                           | تعليمات المشروع لوكلاء الكود                       |
