# تقرير التحقق النهائي (محدّث)

## النتيجة المختصرة
بعد المراجعة الأخيرة، البنود المهمة التي كانت ناقصة في التقرير القديم أصبحت **منقولة ومفعلة** في هيكل `src/extensions` الحالي.  
لا يوجد حاليًا جزء أساسي إضافي مطلوب نقله من الملفات الثلاثة لتحقيق خطة الدمج المتفق عليها.

## ما تم التأكد من وجوده الآن
1. مسار الذاكرة/الهجين:
- `ContextMemoryManager` موجود في `src/extensions/context-memory-manager.ts`.
- `HybridClassifier` موجود في `src/extensions/hybrid-classifier.ts`.

2. طبقة القرار المتقدمة:
- `scoreActionEvidence`, `passesActionDefinitionGate`, `passesDialogueDefinitionGate`, `passesCharacterDefinitionGate`, `resolveNarrativeDecision`
  موجودة في `src/extensions/classification-decision.ts` ومستخدمة في `src/extensions/paste-classifier.ts`.

3. إصلاح النص المكسور قبل التصنيف:
- `shouldMergeWrappedLines`, `mergeBrokenCharacterName`, `parseBulletLine`, `extractPlainTextFromHtmlLikeLine`
  موجودة في `src/extensions/line-repair.ts` ومربوطة داخل `src/extensions/paste-classifier.ts`.

4. الأنماط اللغوية الواسعة:
- `DIALECT_PATTERNS`, `detectDialect`, `NEGATION_PATTERNS`, `DATE_PATTERNS`, `TIME_PATTERNS`, `ABBREVIATION_PATTERNS`,
  `SCENE_HEADER3_CANDIDATE_RE`, `SCENE_HEADER3_KNOWN_PLACES_RE`, `SCENE_HEADER3_MULTI_LOCATION_RE`,
  `PRONOUN_PLUS_VERB_RE`, `PRONOUN_PREFIX_RE`, `MASDAR_PREFIX_RE`
  موجودة في `src/extensions/arabic-patterns.ts`.

5. تكامل Reviewer:
- `PostClassificationReviewer` مدمج ومُشغَّل داخل `src/extensions/paste-classifier.ts`.

6. شرط النقطتين بعد اسم الشخصية:
- فرض النمط في `character` عبر `ensureCharacterTrailingColon`، ويُطبق أثناء الإدخال وأثناء التصنيف.

## ما لا نحتاج نقله حاليًا (عن قصد)
1. مسارات React/DOM القديمة الخاصة بـ `contenteditable` والـ HTML formatting.
2. إدارة `AbortController`/pending confirmations الخاصة بمسار Agent القديم.
3. بعض التركيبات التراثية في `classification-core` (مثل `DialogueBlock` و`LineRelation`) لأنها غير مطلوبة في المعمارية الحالية.

## تحقق التكامل
تم تنفيذ `npm run build` بنجاح بعد الدمج، بدون أخطاء TypeScript.

## قرار نهائي
لا نحتاج حاليًا أي نقل إضافي من الملفات الثلاثة المذكورة.  
أي إضافة لاحقة ستكون تحسين دقة اختياري (Product choice) وليست نقصًا في الدمج الحالي.

---

## تحديث مرحلة نقل `migration/types` + `migration/utils` (Tiptap File Import)

### النتيجة المختصرة
تم تنفيذ مسار فتح الملفات على بنية Tiptap كـ Pipeline كامل:
`Pick file -> Extract -> Preprocess -> Open Pipeline -> Structured/Classifier Insert`.

### الملفات المنقولة بالكامل
1. `migration/types/file-import.ts` -> `src/types/file-import.ts`
2. `migration/types/structure-pipeline.ts` -> `src/types/structure-pipeline.ts`
3. `migration/types/editor-clipboard.ts` -> `src/types/editor-clipboard.ts`
4. `migration/types/editor-engine.ts` -> `src/types/editor-engine.ts`
5. `migration/types/typing-system.ts` -> `src/types/typing-system.ts`
6. `migration/utils/file-import-preprocessor.ts` -> `src/utils/file-import/preprocessor.ts`
7. `migration/utils/file-open-pipeline.ts` -> `src/utils/file-import/open-pipeline.ts`
8. `migration/utils/plain-text-to-blocks.ts` -> `src/utils/file-import/plain-text-to-blocks.ts`

### الملفات المنقولة جزئيًا (بعد التطبيع على Tiptap)
1. `migration/types/screenplay.ts` -> `src/types/screenplay.ts`
- المنقول: `DocumentStats` + `LineType` فقط.
- المستبعد: أنواع واجهة React/UI غير اللازمة لمسار الاستيراد.

2. `migration/types/declarations.d.ts` + `migration/types/external-modules.d.ts` -> `src/types/external-modules.d.ts`
- المنقول: تعريفات `mammoth` و `pdfjs-dist` اللازمة للاستخراج المتصفح.
- المستبعد: تعريفات لا تُستخدم في هذه المرحلة.

3. `migration/utils/document-model.ts` -> `src/utils/file-import/document-model.ts`
- تمت إعادة البناء ليدعم:
  - Legacy `format-*`
  - Current `data-type`
  - payload marker round-trip

4. `migration/utils/structure-pipeline.ts` -> `src/utils/file-import/structure-pipeline.ts`
- تم ضبط mapping لأنواع المشروع الحالية (`scene-header-*` + `data-type` flow).

5. `migration/utils/file-extraction.ts` -> `src/utils/file-import/extract/*`
- تم تقسيمه إلى:
  - `browser-extract.ts`
  - `backend-extract.ts`
  - `index.ts` (orchestrator + fallback)

6. `migration/utils/file-operations.ts` -> `src/utils/file-import/file-picker.ts`
- المنقول: file picker ومسار القراءة.
- المستبعد: save/export غير المرتبطين بمرحلة الفتح.

7. `migration/utils/logger.ts` -> `src/utils/logger.ts`
- نسخة خفيفة متوافقة مع Vite (`import.meta.env.DEV`) بدل `process.env`.

### الملفات التي لم تُنقل (عن قصد) + السبب
1. `migration/utils/paste-classifier.ts`
- React/contenteditable-specific؛ البديل الفعلي موجود في `src/extensions/paste-classifier.ts`.

2. `migration/utils/editor-styles.ts`
- مبني على `React.CSSProperties` وطبقة تنسيق قديمة غير مطلوبة لبنية Nodes الحالية.

3. `migration/utils/typing-workflow-rules.ts` + `migration/utils/screenplay-rules.ts`
- مرتبطة بـ format workflow legacy وتحتاج تصميم جديد إذا تقرر تفعيلها.

4. `migration/utils/doc-converter-flow.ts`
5. `migration/utils/pdf-converter-flow.ts`
6. `migration/utils/pdf-converter-flow-runner.ts`
7. `migration/utils/mistral-ocr.ts`
- Node/CLI أو server-key sensitive؛ موضعها Backend وليس frontend.

8. `migration/utils/Arabic-Screenplay-Classifier-Agent.ts`
9. `migration/types/agent-review.ts`
- طبقة Agent خارج نطاق نقل فتح الملفات الحالي.

10. `migration/utils/exporters.ts`, `migration/utils/cn.ts`, `migration/utils/feedback-collector.ts`, `migration/utils/photo-montage.ts`, `migration/utils/index.ts`
- خارج هدف المرحلة (file open/import normalization).

### ربط التكامل في الواجهة الحالية
1. `src/components/editor/editor-area.types.ts`
- إضافة `importStructuredBlocks(blocks, mode?)`.

2. `src/components/editor/EditorArea.ts`
- إضافة إدراج بنيوي مباشر عبر `screenplayBlocksToHtml`.

3. `src/components/editor/ScreenplayEditor.ts`
- استبدال `openFile()` القديم بمسار pipeline الجديد.
- يدعم الأنواع: `.doc,.docx,.txt,.pdf,.fountain,.fdx`.

### سياسة `.env` في هذه المرحلة
1. لم يتم كشف أي مفاتيح حساسة للـ client.
2. المسار backend يعتمد فقط على `VITE_FILE_IMPORT_BACKEND_URL` كـ endpoint.
3. `doc` يتطلب backend endpoint.
4. `pdf` يبدأ text-layer في المتصفح ثم fallback للـ backend إذا الجودة منخفضة وكان endpoint متاحًا.

### التحقق
تم تنفيذ `npm run build` بنجاح بعد الدمج.

---

## تحديث لاحق: تفعيل Agent Review + إعادة `doc` إلى antiword

### ما تم تفعيله
1. تفعيل Workflow وكيل المراجعة بعد `PostClassificationReviewer` داخل مسار اللصق:
- تجميع السطور المشتبهة فقط + سياقها.
- إرسالها إلى `POST /api/agent/review`.
- تطبيق قرارات الوكيل على السطور الصالحة فقط.
- عند فشل/تخطي الوكيل: الرجوع تلقائيًا لنتيجة التصنيف المحلي.

2. نقل عقد Agent Review فعليًا:
- `src/types/agent-review.ts`
- وتصديرها من `src/types/index.ts`.

3. إضافة endpoint المراجعة في السيرفر المحلي:
- `server/file-import-server.mjs` يدعم الآن:
  - `POST /api/file-extract`
  - `POST /api/agent/review`
  - `GET /health`

### إعادة `doc` لمسار antiword (مطابق القديم)
1. تم إلغاء `doc` عبر OCR.
2. `doc` أصبح عبر antiword بنفس فلسفة `doc-converter-flow`:
- كتابة الملف المؤقت
- تشغيل antiword
- تنظيف النص
- إرجاع `method = doc-converter-flow` و `usedOcr = false`

3. `pdf` ما زال OCR عبر Mistral كما كان.

### ملاحظة نشر Railway
- يلزم وجود `antiword` في صورة التشغيل/البيئة.
- يمكن ضبط:
  - `ANTIWORD_PATH`
  - `ANTIWORDHOME`
